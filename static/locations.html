<!DOCTYPE html>
    <head>
        <title>Garrud Employee Locator</title>
    </head>
    <body>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <h1>Garrud Employee Locator</h1>
        <div id="employees"></div>
        <script>
            var employees = null;
            var employeesElement = document.getElementById('employees');
            var employeesTable = document.createElement('table');
            employeesTable.setAttribute('id', 'emp_details');
            employeesTable.setAttribute('border', '1');
            employeesTable.setAttribute('padding', '5px');
            var table_frame = document.createElement('tr');
            const col1 = document.createElement('td');
            col1.innerText = 'Name';
            const col2 = document.createElement('td');
            col2.innerText = 'Last Location';
            const col3 = document.createElement('td');
            col3.innerText = 'Last Location Time';
            const col4 = document.createElement('td');
            col4.innerText = 'Distance since 9 AM';
            table_frame.appendChild(col1);
            table_frame.appendChild(col2);
            table_frame.appendChild(col3);
            table_frame.appendChild(col4);
            employeesTable.appendChild(table_frame);
            employeesElement.appendChild(employeesTable);
            axios.get('https://garrud-employee-locator.herokuapp.com/employees').then(function(response) {
                employees = response.data.Employees;
                employees.forEach(function(employee) {
                    axios.get('https://garrud-employee-locator.herokuapp.com/details/' + employee.user_name).then(function(_response) {
                        const locations = _response.data.Locations;
                        const last_location = locations[locations.length-1];
                        if(locations.length > 1) {
                            const distanceValue = calculateDistance(locations);
                        } else {
                            distanceValue = 0;
                        }
                        var tableElement = document.getElementById('emp_details');
                        var row = document.createElement('tr');
                        var name = document.createElement('td');
                        name.innerText = employee.employee_name;
                        var lastLocationElement = document.createElement('td');
                        console.log(Object.keys(last_location));
                        lastLocationElement.innerHTML = '<a href="https://www.google.com/maps/search/?api=1&query=' + last_location.Lat + ',' + last_location.Lng + '" target=_blank>' + last_location.Lat + ',' + last_location.Lng + '</a>';
                        var lastLocationTime = document.createElement('td');
                        lastLocationTime.innerText = last_location.time;
                        var distance = document.createElement('td');
                        distance.innerText = distanceValue;
                        row.appendChild(name);
                        row.appendChild(lastLocationElement);
                        row.appendChild(lastLocationTime);
                        row.appendChild(distance);
                        tableElement.appendChild(row);
                    }).catch(function(err) {
                        console.log(err);
                    });
                });
            }).catch(function(err) {
                console.log(err);
            });
            function calculateDistance(locations) {
                var distance = 0;
                const R = 6371e3; // metres
                for(var i=0;i<locations.length-1;i++) {
                    const lat1 = locations[i].Lat;
                    const lon1 = locations[i].Lng;
                    const lat2 = locations[i+1].Lat;
                    const lon2 = locations[i+1].Lng;
                    const φ1 = lat1 * Math.PI/180; // φ, λ in radians
                    const φ2 = lat2 * Math.PI/180;
                    const Δφ = (lat2-lat1) * Math.PI/180;
                    const Δλ = (lon2-lon1) * Math.PI/180;
                    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    distance += R * c; // in metres
                }
                distance /= 1000;
                return distance;
            }
        </script>
    </body>
</html>